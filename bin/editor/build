#!/usr/bin/env bash

###
echo 'Step 1: Build editor'
docker compose exec editor yarn build

###
echo 'Step 2: Move files to public'
PATH_TARGET="./public/editor"
PATH_SOURCE="./depts/editor/dist/editor"

if test -d $PATH_TARGET; then
  rm -R $PATH_TARGET
fi

if test -d $PATH_SOURCE; then
  mv $PATH_SOURCE $PATH_TARGET
fi

###
echo 'Step 3: Update editor-version in .env-file.'
ENV_FILE=".env.dev.local"
NEW_VERSION="$(date +%Y%m%d%H%M%S)"  # or: NEW_VERSION="$(git rev-parse --short HEAD)"

[ -f "$ENV_FILE" ] || touch "$ENV_FILE"

if grep -qE '^APP_EDITOR_VERSION=' "$ENV_FILE"; then
  tmpfile="$(mktemp)"
  sed -E "s|^APP_EDITOR_VERSION=.*$|APP_EDITOR_VERSION=${NEW_VERSION}|" "$ENV_FILE" > "$tmpfile" && mv "$tmpfile" "$ENV_FILE"
else
  echo "APP_EDITOR_VERSION=${NEW_VERSION}" >> "$ENV_FILE"
fi
